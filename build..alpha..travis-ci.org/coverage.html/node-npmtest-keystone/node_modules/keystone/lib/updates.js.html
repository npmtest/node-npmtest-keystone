<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for node-npmtest-keystone/node_modules/keystone/lib/updates.js</title>
    <meta charset="utf-8">
    <style>
        body, html {
            margin:0; padding: 0;
        }
        body {
            font-family: Arial, Helvetica;
            font-size: 10pt;
        }
        div.header, div.footer {
            background: #eee;
            padding: 1em;
        }
        div.header {
            height: 160px;
            padding: 0 1em 0 1em;
            z-index: 100;
            position: fixed;
            top: 0;
            border-bottom: 1px solid #666;
            width: 100%;
        }
        div.footer {
            border-top: 1px solid #666;
        }
        div.body {
            margin-top: 170px;
        }
        div.meta {
            font-size: 90%;
            text-align: center;
        }
        h1, h2, h3 {
            font-weight: normal;
        }
        h1 {
            font-size: 12pt;
        }
        h2 {
            font-size: 10pt;
        }
        pre {
            font-family: Menlo, Monaco, Consolas, Courier New, monospace;
            margin: 0;
            padding: 0;
            font-size: 14px;
            tab-size: 2;
        }

        div.path { font-size: 110%; }
        div.path a:link, div.path a:visited { color: #000; }
        table.coverage { border-collapse: collapse; margin:0; padding: 0 }

        table.coverage td {
            margin: 0;
            padding: 0;
            color: #111;
            vertical-align: top;
        }
        table.coverage td.line-count {
            width: 50px;
            text-align: right;
            padding-right: 5px;
        }
        table.coverage td.line-coverage {
            color: #777 !important;
            text-align: right;
            border-left: 1px solid #666;
            border-right: 1px solid #666;
        }

        table.coverage td.text {
        }

        table.coverage td span.cline-any {
            display: inline-block;
            padding: 0 5px;
            width: 40px;
        }
        table.coverage td span.cline-neutral {
            background: #eee;
        }
        table.coverage td span.cline-yes {
            background: #b5d592;
            color: #999;
        }
        table.coverage td span.cline-no {
            background: #fc8c84;
        }

        .cstat-yes { color: #111; }
        .cstat-no { background: #fc8c84; color: #111; }
        .fstat-no { background: #ffc520; color: #111 !important; }
        .cbranch-no { background:  yellow !important; color: #111; }

        .cstat-skip { background: #ddd; color: #111; }
        .fstat-skip { background: #ddd; color: #111 !important; }
        .cbranch-skip { background: #ddd !important; color: #111; }

        .missing-if-branch {
            display: inline-block;
            margin-right: 10px;
            position: relative;
            padding: 0 4px;
            background: black;
            color: yellow;
        }

        .skip-if-branch {
            display: none;
            margin-right: 10px;
            position: relative;
            padding: 0 4px;
            background: #ccc;
            color: white;
        }

        .missing-if-branch .typ, .skip-if-branch .typ {
            color: inherit !important;
        }

        .entity, .metric { font-weight: bold; }
        .metric { display: inline-block; border: 1px solid #333; padding: 0.3em; background: white; }
        .metric small { font-size: 80%; font-weight: normal; color: #666; }

        div.coverage-summary table { border-collapse: collapse; margin: 3em; font-size: 110%; }
        div.coverage-summary td, div.coverage-summary table  th { margin: 0; padding: 0.25em 1em; border-top: 1px solid #666; border-bottom: 1px solid #666; }
        div.coverage-summary th { text-align: left; border: 1px solid #666; background: #eee; font-weight: normal; }
        div.coverage-summary th.file { border-right: none !important; }
        div.coverage-summary th.pic { border-left: none !important; text-align: right; }
        div.coverage-summary th.pct { border-right: none !important; }
        div.coverage-summary th.abs { border-left: none !important; text-align: right; }
        div.coverage-summary td.pct { text-align: right; border-left: 1px solid #666; }
        div.coverage-summary td.abs { text-align: right; font-size: 90%; color: #444; border-right: 1px solid #666; }
        div.coverage-summary td.file { text-align: right; border-left: 1px solid #666; white-space: nowrap;  }
        div.coverage-summary td.pic { min-width: 120px !important;  }
        div.coverage-summary a:link { color: #000; }
        div.coverage-summary a:visited { color: #333; }
        div.coverage-summary tfoot td { border-top: 1px solid #666; }

        div.coverage-summary .yui3-datatable-sort-indicator, div.coverage-summary .dummy-sort-indicator {
            height: 10px;
            width: 7px;
            display: inline-block;
            margin-left: 0.5em;
        }
        div.coverage-summary .yui3-datatable-sort-indicator {
            background: no-repeat scroll 0 0 transparent;
        }
        div.coverage-summary .yui3-datatable-sorted .yui3-datatable-sort-indicator {
            background-position: 0 -20px;
        }
        div.coverage-summary .yui3-datatable-sorted-desc .yui3-datatable-sort-indicator {
            background-position: 0 -10px;
        }

        .high { background: #b5d592 !important; }
        .medium { background: #ffe87c !important; }
        .low { background: #fc8c84 !important; }

        span.cover-fill, span.cover-empty {
            display:inline-block;
            border:1px solid #444;
            background: white;
            height: 12px;
        }
        span.cover-fill {
            background: #ccc;
            border-right: 1px solid #444;
        }
        span.cover-empty {
            background: white;
            border-left: none;
        }
        span.cover-full {
            border-right: none !important;
        }
        pre.prettyprint {
            border: none !important;
            padding: 0 !important;
            margin: 0 !important;
        }
        .com { color: #999 !important; }
        .ignore-none { color: #999; font-weight: normal; }

    </style>
</head>
<body>
<div class="header low">
    <h1 style="font-weight: bold;">
        <a href="https://github.com/npmtest/node-npmtest-keystone">npmtest-keystone (v0.0.1)</a>
    </h1>
    <h1>Code coverage report for <span class="entity">node-npmtest-keystone/node_modules/keystone/lib/updates.js</span></h1>
    <h2>
        
        Statements: <span class="metric">10.1% <small>(10 / 99)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        
        
        Branches: <span class="metric">0% <small>(0 / 66)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        
        
        Functions: <span class="metric">0% <small>(0 / 14)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        
        
        Lines: <span class="metric">10.1% <small>(10 / 99)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        
        Ignored: <span class="metric"><span class="ignore-none">none</span></span> &nbsp;&nbsp;&nbsp;&nbsp;
    </h2>
    <div class="path"><a href="../../../../index.html">All files</a> &#187; <a href="index.html">node-npmtest-keystone/node_modules/keystone/lib/</a> &#187; updates.js</div>
</div>
<div class="body">
<pre><table class="coverage">
<tr><td class="line-count">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184</td><td class="line-coverage"><span class="cline-any cline-yes">2</span>
<span class="cline-any cline-yes">2</span>
<span class="cline-any cline-yes">2</span>
<span class="cline-any cline-yes">2</span>
<span class="cline-any cline-yes">2</span>
<span class="cline-any cline-yes">2</span>
<span class="cline-any cline-yes">2</span>
<span class="cline-any cline-yes">2</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">var _ = require('underscore');
var async = require('async');
var fs = require('fs');
var keystone = require('../');
var mongoose = keystone.mongoose;
var path = require('path');
var semver = require('semver');
var utils = require('keystone-utils');
&nbsp;
var _dashes_ = '------------------------------------------------';
&nbsp;
// Update Schema - automatically created and managed by Keystone when updates are used
var UpdateModel = new mongoose.Schema({
	key: { type: String, index: true },
	appliedOn: { type: Date, default: Date.now }
}, { collection: keystone.prefixModel('App_Update') });
<span class="cstat-no" title="statement not covered" >mongoose.model('App_Update', UpdateModel);</span>
&nbsp;
// Apply method - loads the available updates and applies any that haven't been, in order
<span class="cstat-no" title="statement not covered" >exports.apply = <span class="fstat-no" title="function not covered" >function(callback) {</span></span>
&nbsp;
<span class="cstat-no" title="statement not covered" >	var Update = mongoose.model('App_Update');</span>
<span class="cstat-no" title="statement not covered" >	var updateCount = 0;</span>
<span class="cstat-no" title="statement not covered" >	var deferCount = 0;</span>
<span class="cstat-no" title="statement not covered" >	var skipCount = 0;</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >	var updatesPath = keystone.getPath('updates', 'updates');</span>
&nbsp;
	// logError is used to log errors before the process exits since it is more synchronous than console.error.  Using 
	// console.error gets into race condition issues with process.exit, which has higher priority.
<span class="cstat-no" title="statement not covered" >	var logError = <span class="fstat-no" title="function not covered" >function() {</span></span>
<span class="cstat-no" title="statement not covered" >		for (var i = 0, len = arguments.length; i &lt; len; ++i) {</span>
<span class="cstat-no" title="statement not covered" >			process.stderr.write(arguments[i] + '\n');</span>
		}
	};
&nbsp;
<span class="cstat-no" title="statement not covered" >	var applyUpdate = <span class="fstat-no" title="function not covered" >function(file, done) {</span></span>
<span class="cstat-no" title="statement not covered" >		Update.findOne({ key: file }, <span class="fstat-no" title="function not covered" >function(err, updateRecord) {</span></span>
<span class="cstat-no" title="statement not covered" >			if (err) {</span>
<span class="cstat-no" title="statement not covered" >				console.error('Error searching database for update ' + file + ':');</span>
<span class="cstat-no" title="statement not covered" >				console.dir(err);</span>
<span class="cstat-no" title="statement not covered" >				done(err);</span>
			} else <span class="cstat-no" title="statement not covered" >if (!updateRecord) {</span>
<span class="cstat-no" title="statement not covered" >				var update = require(path.join(updatesPath, file));</span>
				// skip updates that export a falsy value
<span class="cstat-no" title="statement not covered" >				if (!update) {</span>
<span class="cstat-no" title="statement not covered" >					skipCount++;</span>
<span class="cstat-no" title="statement not covered" >					return done();</span>
				}
				// auto-wrap create scripts for a friendlier shorthand syntax
<span class="cstat-no" title="statement not covered" >				if (_.isObject(update.create)) {</span>
<span class="cstat-no" title="statement not covered" >					var items = update.create,</span>
						ops = update.options || {};
<span class="cstat-no" title="statement not covered" >					var background_mode = update.__background__ ? ' (background mode) ' : '';</span>
					
<span class="cstat-no" title="statement not covered" >					update = <span class="fstat-no" title="function not covered" >function(done) {</span></span>
<span class="cstat-no" title="statement not covered" >						keystone.createItems(items, ops, <span class="fstat-no" title="function not covered" >function(err, stats) {</span></span>
<span class="cstat-no" title="statement not covered" >							if (!err) {</span>
<span class="cstat-no" title="statement not covered" >								var statsMsg = stats ? stats.message : '';</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >								console.log('\n' + _dashes_,</span>
									'\n' + keystone.get('name') + ': Successfully applied update ' + file + background_mode + '.',
									'\n' + statsMsg,
									'\n');
<span class="cstat-no" title="statement not covered" >								done(null);</span>
							}
							else {
<span class="cstat-no" title="statement not covered" >								logError('\n' + _dashes_,</span>
									'\n' + keystone.get('name') + ': Update ' + file + background_mode + ' failed with errors:',
									'\n' + err,
									'\n');
&nbsp;
								// give the logging some time to finish
<span class="cstat-no" title="statement not covered" >								process.nextTick(<span class="fstat-no" title="function not covered" >function() {</span></span>
<span class="cstat-no" title="statement not covered" >									done(err);</span>
								});
							}
						});
					};
				}
				// ensure type
<span class="cstat-no" title="statement not covered" >				if (!_.isFunction(update)) {</span>
<span class="cstat-no" title="statement not covered" >					console.log('\nError in update file ./updates/' + file + '.js\nUpdate files must export a function\n');</span>
<span class="cstat-no" title="statement not covered" >					process.exit();</span>
				}
				// if an update is deferred, don't process it
<span class="cstat-no" title="statement not covered" >				if (update.__defer__) {</span>
<span class="cstat-no" title="statement not covered" >					deferCount++;</span>
<span class="cstat-no" title="statement not covered" >					return done();</span>
				}
				// if there are deferred updates, don't process any subsequent ones
<span class="cstat-no" title="statement not covered" >				if (deferCount) {</span>
<span class="cstat-no" title="statement not covered" >					skipCount++;</span>
<span class="cstat-no" title="statement not covered" >					return done();</span>
				}
<span class="cstat-no" title="statement not covered" >				console.log(_dashes_ + '\nApplying update ' + file + '...');</span>
<span class="cstat-no" title="statement not covered" >				if (update.__background__) {</span>
<span class="cstat-no" title="statement not covered" >					updateCount++;</span>
<span class="cstat-no" title="statement not covered" >					update(<span class="fstat-no" title="function not covered" >function(err) {</span></span>
<span class="cstat-no" title="statement not covered" >						if (!err) {</span>
<span class="cstat-no" title="statement not covered" >							if (update.__commit__ !== false) {</span>
<span class="cstat-no" title="statement not covered" >								new Update({ key: file }).save();</span>
							}
						}
					});
<span class="cstat-no" title="statement not covered" >					done();</span>
				} else {
<span class="cstat-no" title="statement not covered" >					update(<span class="fstat-no" title="function not covered" >function(err) {</span></span>
<span class="cstat-no" title="statement not covered" >						if (!err) {</span>
<span class="cstat-no" title="statement not covered" >							updateCount++;</span>
<span class="cstat-no" title="statement not covered" >							if (update.__commit__ === false) {</span>
<span class="cstat-no" title="statement not covered" >								done();</span>
							} else {
<span class="cstat-no" title="statement not covered" >								new Update({ key: file }).save(done);</span>
							}
						}
					});
				}
			} else {
<span class="cstat-no" title="statement not covered" >				done();</span>
			}
		});
	};
&nbsp;
<span class="cstat-no" title="statement not covered" >	if (!fs.existsSync(updatesPath)) {</span>
<span class="cstat-no" title="statement not covered" >		console.log('\nKeystoneJS Update Error:\n\n' +</span>
			'An updates folder must exist in your project root to use automatic updates.\n' +
			'If you want to use a custom path for your updates, set the `updates` option.\n' +
			'If you don\'t want to use updates, set the `auto update` option to `false`.\n' +
			'See http://keystonejs.com/docs/configuration/#updates for more information.\n');
<span class="cstat-no" title="statement not covered" >		process.exit();</span>
	}
&nbsp;
<span class="cstat-no" title="statement not covered" >	var updates = fs.readdirSync(updatesPath)</span>
		.map(<span class="fstat-no" title="function not covered" >function(i) {</span>
			// exclude non-javascript or coffee files in the updates folder
<span class="cstat-no" title="statement not covered" >			return (path.extname(i) !== '.js' &amp;&amp; path.extname(i) !== '.coffee') ? false : path.basename(i, '.js');</span>
		}).filter(<span class="fstat-no" title="function not covered" >function(i) {</span>
			// exclude falsy values and filenames that without a valid semver
<span class="cstat-no" title="statement not covered" >			return i &amp;&amp; semver.valid(i.split('-')[0]);</span>
		}).sort(<span class="fstat-no" title="function not covered" >function(a, b) {</span>
			// exclude anything after a hyphen from the version number
<span class="cstat-no" title="statement not covered" >			return semver.compare(a.split('-')[0], b.split('-')[0]);</span>
		});
&nbsp;
<span class="cstat-no" title="statement not covered" >	async.eachSeries(updates, applyUpdate, <span class="fstat-no" title="function not covered" >function(err) {</span></span>
<span class="cstat-no" title="statement not covered" >		if (updateCount || deferCount || skipCount) {</span>
<span class="cstat-no" title="statement not covered" >			var status = '';</span>
<span class="cstat-no" title="statement not covered" >			if (updateCount) {</span>
<span class="cstat-no" title="statement not covered" >				status += 'Successfully applied ' + utils.plural(updateCount, '* update');</span>
<span class="cstat-no" title="statement not covered" >				if (skipCount || deferCount) {</span>
<span class="cstat-no" title="statement not covered" >					status += ', ';</span>
				}
			}
<span class="cstat-no" title="statement not covered" >			if (deferCount) {</span>
<span class="cstat-no" title="statement not covered" >				status += 'Deferred ' + utils.plural(deferCount, '* update');</span>
<span class="cstat-no" title="statement not covered" >				if (skipCount) {</span>
<span class="cstat-no" title="statement not covered" >					status += ', ';</span>
				}
			}
<span class="cstat-no" title="statement not covered" >			if (skipCount) {</span>
<span class="cstat-no" title="statement not covered" >				status += 'Skipped ' + utils.plural(skipCount, '* update');</span>
			}
<span class="cstat-no" title="statement not covered" >			status += '.';</span>
<span class="cstat-no" title="statement not covered" >			console.log(_dashes_ + '\n' + status + '\n' + _dashes_);</span>
		}
<span class="cstat-no" title="statement not covered" >		if (err) {</span>
<span class="cstat-no" title="statement not covered" >			var errmsg = 'An error occurred applying updates, bailing on Keystone init.\n\nError details:';</span>
<span class="cstat-no" title="statement not covered" >			if (!(updateCount || deferCount || skipCount)) {</span>
<span class="cstat-no" title="statement not covered" >				errmsg = _dashes_ + '\n' + errmsg;</span>
			}
<span class="cstat-no" title="statement not covered" >			logError(errmsg);</span>
<span class="cstat-no" title="statement not covered" >			logError(err);</span>
			// wait till nextTick to exit so the trace completes.
<span class="cstat-no" title="statement not covered" >			process.nextTick(<span class="fstat-no" title="function not covered" >function() {</span></span>
<span class="cstat-no" title="statement not covered" >				process.exit(1);</span>
			});
<span class="cstat-no" title="statement not covered" >			return;</span>
		}
<span class="cstat-no" title="statement not covered" >		callback &amp;&amp; callback();/</span>/ eslint-disable-line no-unused-expressions
	});
};
&nbsp;
&nbsp;</pre></td></tr>
</table></pre>
</div>
<div class="footer">
    <div class="meta">Generated by <a href="https://github.com/kaizhu256/node-utility2" target="_blank">utility2</a> at Tue Apr 18 2017 21:09:05 GMT+0000 (UTC)</div>
</div>
</body>
</html>
